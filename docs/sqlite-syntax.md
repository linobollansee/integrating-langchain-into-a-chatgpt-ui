# SQLite Syntax Documentation

This document provides a comprehensive reference for all SQLite database operations and syntax used in this project.

## Table of Contents

- [Imports](#imports)
- [Database Initialization](#database-initialization)
- [Schema Definition](#schema-definition)
- [CRUD Operations](#crud-operations)
- [Query Patterns](#query-patterns)
- [Type Safety](#type-safety)

---

## Imports

### SQLite Package Imports

```typescript
import sqlite3 from "sqlite3";
import { open, Database } from "sqlite";
```

**Purpose:**

- `sqlite3`: Core SQLite driver
- `open`: Function to open/create database connection
- `Database`: TypeScript type for database instance

---

## Database Initialization

### Opening a Database Connection

```typescript
db = await open({
  filename: "./chat.db",
  driver: sqlite3.Database,
});
```

**Parameters:**

- `filename`: Path to SQLite database file (created if doesn't exist)
- `driver`: SQLite driver class to use

### Database Instance Type

```typescript
let db: Database<sqlite3.Database, sqlite3.Statement> | null = null;
```

**Type Definition:**

- Typed with SQLite3 driver and statement types
- Initialized as `null` and set when database opens

---

## Schema Definition

### CREATE TABLE Statement

```typescript
await db.exec(`
  CREATE TABLE IF NOT EXISTS messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL,
    role TEXT NOT NULL,
    content TEXT NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
  );
`);
```

**Column Types:**

- `INTEGER PRIMARY KEY AUTOINCREMENT`: Auto-incrementing ID
- `TEXT NOT NULL`: Required text field
- `DATETIME DEFAULT CURRENT_TIMESTAMP`: Auto-set timestamp

### CREATE INDEX Statement

```typescript
CREATE INDEX IF NOT EXISTS idx_session_id ON messages(session_id);
```

**Purpose:**

- Speeds up queries filtering by `session_id`
- `IF NOT EXISTS` prevents errors on re-initialization

---

## CRUD Operations

### INSERT - Saving a Message

```typescript
const result = await db.run(
  "INSERT INTO messages (session_id, role, content) VALUES (?, ?, ?)",
  [message.session_id, message.role, message.content]
);
```

**Method:** `db.run()`
**Returns:** Object with `lastID` property (the inserted row ID)

**Parameterized Query:**

- Use `?` placeholders for values
- Pass values in array as second argument
- Prevents SQL injection

### SELECT - Querying Messages

```typescript
const messages = await db.all<Message[]>(
  "SELECT * FROM messages WHERE session_id = ? ORDER BY timestamp ASC",
  [sessionId]
);
```

**Method:** `db.all<T>()`
**Returns:** Array of all matching rows

**Features:**

- `WHERE` clause for filtering
- `ORDER BY` for sorting
- Generic type parameter for TypeScript type safety

### SELECT DISTINCT - Getting Unique Sessions

```typescript
const sessions = await db.all<{ session_id: string }[]>(
  "SELECT DISTINCT session_id FROM messages GROUP BY session_id ORDER BY session_id DESC"
);
```

**SQL Keywords:**

- `DISTINCT`: Returns only unique values
- `GROUP BY`: Groups rows by column
- `ORDER BY ... DESC`: Sort in descending order

### DELETE - Removing a Session

```typescript
await db.run("DELETE FROM messages WHERE session_id = ?", [sessionId]);
```

**Method:** `db.run()`
**Purpose:** Delete all messages for a specific session

---

## Query Patterns

### Filtering with WHERE

```sql
WHERE session_id = ?
```

Filter results based on condition with parameterized value.

### Sorting Results

```sql
ORDER BY timestamp ASC
ORDER BY session_id DESC
```

- `ASC`: Ascending order (oldest first)
- `DESC`: Descending order (newest first)

### Grouping and Aggregation

```sql
SELECT DISTINCT session_id FROM messages GROUP BY session_id
```

Group rows and return unique session IDs.

---

## Type Safety

### TypeScript Interface

```typescript
export interface Message {
  id?: number;
  session_id: string;
  role: "user" | "assistant";
  content: string;
  timestamp?: string;
}
```

**Field Types:**

- `id?`: Optional (not present when creating new messages)
- `role`: Union type limiting to specific strings
- `timestamp?`: Optional (auto-generated by database)

### Generic Type Annotations

```typescript
db.all<Message[]>(query, params);
db.all<{ session_id: string }[]>(query, params);
```

**Purpose:**

- Provides compile-time type checking
- IntelliSense support
- Ensures type safety between database and application

---

## Complete Database Module

### Initialization Pattern

```typescript
let db: Database<sqlite3.Database, sqlite3.Statement> | null = null;

export async function initDatabase(): Promise<void> {
  db = await open({
    filename: "./chat.db",
    driver: sqlite3.Database,
  });

  await db.exec(`CREATE TABLE IF NOT EXISTS ...`);
}
```

### Error Handling

```typescript
if (!db) throw new Error("Database not initialized");
```

**Always check** if database is initialized before operations.

---

## Key Concepts

### Parameterized Queries

✅ **DO:**

```typescript
db.run("SELECT * FROM messages WHERE id = ?", [id]);
```

❌ **DON'T:**

```typescript
db.run(`SELECT * FROM messages WHERE id = ${id}`); // SQL injection risk!
```

### Async/Await Pattern

All database operations are asynchronous:

```typescript
const result = await db.run(...);
const rows = await db.all(...);
await db.exec(...);
```

### Transaction Safety

- SQLite handles transactions automatically for single operations
- Use `db.exec()` for multiple statements in one transaction

---

## Dependencies

### Required Packages

```json
{
  "sqlite": "^5.1.1",
  "sqlite3": "^5.1.7"
}
```

---

_Last Updated: January 6, 2026_
